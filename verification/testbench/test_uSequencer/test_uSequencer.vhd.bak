library ieee;
use ieee.std_logic_1164.all;
library lpm;
use lpm.lpm_components.all;

entity lab7Part1A is
	port(
		clk, clear: in std_logic;
		useqEnOut: out std_logic;
		ctrlSignals: out std_logic_vector(0 to 7);
		address_out: out std_logic_vector(8 downto 0);
		M_disp, disp1, disp0: out std_logic_vector(0 to 6)
	);
end lab7Part1A;

architecture structural of lab7Part1A is
component uSeqeuncer is
  generic(
    uROM_width: integer := 10;
    uROM_file: string := ""
  );
  port(
    opcode: in std_logic_vector(3 downto 0);
    uop: out std_logic_vector(1 to (uROM_width-9));
    debug_map_addr: out std_logic_vector(8 downto 0);  -- for debugging
    enable, clear: in std_logic;
    clock: in std_logic
  );
end uSeqeuncer

component seven_segment_display is
	port(
		digit: in std_logic_vector(3 downto 0);
		display: out std_logic_vector(0 to 6)
	);
end seven_segment_display;

signal useqEnable, useqClear: std_logic;
signal uop: std_logic_vector(0 to 7);
signal M, addr_hex1, addr_hex0: std_logic_vector(3 downto 0);
begin
	delay: lpm_counter generic map(lpm_width=>2) port map(clock=>clk, cout=>useqEnable);
	
	useqClear <= clear;
	useqEnOut <= useqEnable;
	
	labelG: for i in 0 to 7 generate
		ctrlSignals(i) <= uop(i) and useqEnable;
	end generate;
	
	uSeq: uSequencer
		generic map(uROM_width=>17, uROM_file=>"test_uSequencer_file.mif")
		port map(opcode=>uop(4 to 7), uop=>ctrlSignals, debug_map_addr=>address_out, enable=>useqEnOut, clear=>useqClear, clock=>clk);

	M <= "000" & address_out(8);
	addr_hex1 <= address_out(7 downto 4);
	addr_hex0 <= address_out(3 downtto 0);
	display1: seven_segment_display port map(digit=>M, display=>M_disp);
	display2: seven_segment_display port map(digit=>addr_hex1, display=>disp1);
	display3: seven_segment_display port map(digit=>addr_hex0, display=>disp0);
end structural;